<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />

  <style>
    :root { --primary: #1abc9c; --bg-dark: #f4f7f6; --bg-card: #ffffff; --border: #dee2e6; --danger: #e74c3c; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg-dark); margin: 0; }
    .inventory-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
    
    /* UPDATED ACTION BAR LAYOUT */
    .action-bar { background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; display: flex; flex-direction: column; gap: 15px; }
    .action-top { display: flex; justify-content: space-between; align-items: center; }
    .filter-row { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
    
    .table-responsive { background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); overflow-x: auto; }
    .inventory-table { width: 100%; border-collapse: collapse; }
    .inventory-table th { background: #f8f9fa; padding: 15px; text-align: left; border-bottom: 2px solid var(--border); }
    .inventory-table td { padding: 12px 15px; border-bottom: 1px solid var(--border); }
    .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border); }
    
    .modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.6); overflow-y: auto; }
    .modal-content { background: var(--bg-card); margin: 5% auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 15px; position: relative; }
    
    /* View Modal Specifics */
    .view-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    .stock-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .in-stock { background: #e8f4f2; color: #1abc9c; }
    .out-stock { background: #fdeaea; color: #e74c3c; }

    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
    
    /* Customizing Select2 to match theme */
    .select2-container .select2-selection--single { height: 38px !important; border: 1px solid var(--border) !important; display: flex; align-items: center; }
    .select2-container--default .select2-selection--single .select2-selection__arrow { top: 6px !important; }

    .btn { padding: 8px 15px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-weight: 500; border: none; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); }
    .btn-danger { background: var(--danger); color: white; }

    #processingOverlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; align-items: center; justify-content: center; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="inventory-container">
  
  <div class="action-bar">
    <div class="action-top">
      <h1 style="margin:0; font-size: 1.5rem; color: var(--primary);">Inventory Items</h1>
      <button class="btn btn-primary" onclick="invOpenModal()">+ Add Product</button>
    </div>
    
    <div class="filter-row">
      <div style="flex: 2; min-width: 200px;">
        <input type="text" id="invSearch" placeholder="Search by Name or ID..." onkeyup="invFilter()">
      </div>
      <div style="flex: 1; min-width: 150px;">
        <select id="filterBrand" onchange="invFilter()">
          <option value="">All Brands</option>
        </select>
      </div>
      <div style="flex: 1; min-width: 150px;">
        <select id="filterCategory" onchange="invFilter()">
          <option value="">All Categories</option>
        </select>
      </div>
      <div style="flex: 1; min-width: 150px;">
        <select id="filterSubcat" onchange="invFilter()">
          <option value="">All Subcategories</option>
        </select>
      </div>
      <button class="btn btn-outline" onclick="invResetFilters()" title="Reset Filters">
        <i class="fas fa-undo"></i>
      </button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="inventory-table">
      <thead>
        <tr><th>Image</th><th>Item ID</th><th>Item Name</th><th>Brand</th><th>Category</th><th>Size</th><th>Total Stock</th><th>Actions</th></tr>
      </thead>
      <tbody id="invTableBody"></tbody>
    </table>
  </div>
</div>

<div id="invModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h2 style="margin:0;">Add New Product</h2>
      <i class="fas fa-times" style="cursor:pointer;" onclick="invCloseModal()"></i>
    </div>
    
    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
      <div style="flex: 0 0 200px; text-align: center;">
        <div id="imgPreview" style="width:200px; height:200px; border:2px dashed #ccc; border-radius:10px; display:flex; align-items:center; justify-content:center; margin-bottom:10px; overflow:hidden;">No Image</div>
        <input type="file" id="invImgInput" accept="image/*" style="display:none;" onchange="invPreviewImage(this)">
        <button class="btn btn-outline" onclick="document.getElementById('invImgInput').click()" style="width:100%;">Upload Photo</button>
        <input type="hidden" id="invImgUrl">
      </div>
      <div style="flex: 1; min-width: 300px;">
        <div class="form-grid">
          <div><label>Product Name</label><input type="text" id="invName"></div>
          <div><label>Brand <i class="fas fa-plus-circle" onclick="invAddNew('Brands')"></i></label><select id="invBrand"></select></div>
          <div><label>Category <i class="fas fa-plus-circle" onclick="invAddNew('Item Category')"></i></label><select id="invCategory"></select></div>
          <div><label>Subcategory <i class="fas fa-plus-circle" onclick="invAddNew('Item Subcategory')"></i></label><select id="invSubcat"></select></div>
          <div><label>Reorder Level</label><input type="number" id="invReorder" value="5"></div>
        </div>
        <h4 style="margin: 20px 0 10px 0;">Sizes & Opening Stock</h4>
        <div id="variantContainer"></div>
        <button class="btn btn-outline" style="margin-top:10px;" onclick="invAddVariant()">+ Add Size</button>
      </div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; border-top: 1px solid #eee; padding-top: 20px;">
      <button class="btn btn-outline" onclick="invCloseModal()">Discard</button>
      <button class="btn btn-primary" onclick="invSave()">Save Product</button>
    </div>
  </div>
</div>

<div id="viewModal" class="modal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
      <h2 id="viewTitle" style="margin:0;">Stock Details</h2>
      <i class="fas fa-times" style="cursor:pointer;" onclick="$('#viewModal').hide()"></i>
    </div>
    <div id="viewContent"></div>
    <div style="text-align:right; margin-top:20px;">
      <button class="btn btn-primary" onclick="$('#viewModal').hide()">Close</button>
    </div>
  </div>
</div>

<div id="processingOverlay"><div class="spinner"></div><p style="margin-top:15px;">Processing...</p></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
  let inventoryData = { items: [], brands: [], categories: [], subcategories: [] };

  document.addEventListener('DOMContentLoaded', invLoad);

  function invLoad() {
    $('#processingOverlay').css('display', 'flex');
    google.script.run.withSuccessHandler(data => {
      inventoryData = data;
      renderTable(data.items);
      
      // Populate MODAL Dropdowns
      populateSelect('#invBrand', data.brands);
      populateSelect('#invCategory', data.categories);
      populateSelect('#invSubcat', data.subcategories);
      
      // Populate FILTER Dropdowns
      populateSelect('#filterBrand', data.brands, "All Brands");
      populateSelect('#filterCategory', data.categories, "All Categories");
      populateSelect('#filterSubcat', data.subcategories, "All Subcategories");

      // Initialize Select2 for better UX
      $('#invBrand, #invCategory, #invSubcat').select2({ dropdownParent: $('#invModal'), width: '100%' });
      $('#filterBrand, #filterCategory, #filterSubcat').select2({ width: '100%' });

      $('#processingOverlay').hide();
    }).itemGetInventoryData();
  }

  function populateSelect(selector, list, placeholder = "Select...") {
    const el = $(selector).empty().append(`<option value="">${placeholder}</option>`);
    list.forEach(item => el.append(new Option(item, item)));
  }

  // --- UPDATED FILTER FUNCTION ---
  function invFilter() {
    const searchVal = $('#invSearch').val().toLowerCase();
    const brandVal = $('#filterBrand').val();
    const catVal = $('#filterCategory').val();
    const subVal = $('#filterSubcat').val();

    const filtered = inventoryData.items.filter(item => {
      const matchSearch = (item['Item Name'] || '').toLowerCase().includes(searchVal) || 
                          (item['Item ID'] || '').toLowerCase().includes(searchVal);
      
      const matchBrand = !brandVal || item['Brands'] === brandVal;
      const matchCat = !catVal || item['Item Category'] === catVal;
      const matchSub = !subVal || item['Item Subcategory'] === subVal;

      return matchSearch && matchBrand && matchCat && matchSub;
    });

    renderTable(filtered);
  }

  function invResetFilters() {
    $('#invSearch').val('');
    $('#filterBrand').val('').trigger('change');
    $('#filterCategory').val('').trigger('change');
    $('#filterSubcat').val('').trigger('change');
    invFilter();
  }

  function renderTable(items) {
    const tbody = document.getElementById('invTableBody');
    if (items.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">No products found matching your filters.</td></tr>';
      return;
    }

    tbody.innerHTML = items.map(item => {
      const imgUrl = item['Image URL'];
      const imageTag = imgUrl ? 
        `<img src="${imgUrl}" class="product-img" onerror="this.src='https://placehold.co/50x50?text=Error'">` : 
        `<div class="no-img-placeholder" style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;background:#eee;border-radius:8px;"><i class="fas fa-image" style="color:#ccc;"></i></div>`;

      const rawSize = item['Size'] || '';
      const sizePills = rawSize.split(',').map(s => {
        const sizeName = s.split(':')[0].trim();
        return sizeName ? `<span style="background:#e8f4f2; color:#1abc9c; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:600; margin-right:4px; border:1px solid #1abc9c;">${sizeName}</span>` : '';
      }).join('');

      return `
        <tr>
          <td>${imageTag}</td>
          <td style="font-family:monospace; font-weight:bold; color:#666;">${item['Item ID']}</td>
          <td><b>${item['Item Name']}</b></td>
          <td>${item['Brands']}</td>
          <td>${item['Item Category']}</td>
          <td>${sizePills}</td> 
          <td style="font-weight:bold;">${item['Remaining QTY']}</td>
          <td>
            <button class="btn btn-outline" onclick="invViewItem('${item['Item ID']}')" title="View Stock">
              <i class="fas fa-eye" style="color:var(--primary);"></i>
            </button>
            <button class="btn btn-outline" onclick="invDeleteItem('${item['Item ID']}')" title="Delete">
              <i class="fas fa-trash" style="color:var(--danger);"></i>
            </button>
          </td>
        </tr>`;
    }).join('');
  }

  function invViewItem(id) {
    const item = inventoryData.items.find(i => i['Item ID'] === id);
    if (!item) return;

    $('#viewTitle').text(item['Item Name']);
    const rawSizes = (item['Size'] || '').split(',');
    
    let html = `<div style="display:flex; gap:15px; margin-bottom:15px; background:#f9f9f9; padding:15px; border-radius:10px;">
                  <img src="${item['Image URL'] || 'https://placehold.co/100x100?text=No+Img'}" style="width:80px; height:80px; object-fit:cover; border-radius:8px; border:1px solid #eee;">
                  <div>
                    <div style="font-size:12px; color:#666;">${item['Brands']} | ${item['Item Category']}</div>
                    <div style="font-weight:bold; font-size:18px; margin:5px 0;">${item['Item Name']}</div>
                    <div style="font-size:14px;">Total Stock: <b>${item['Remaining QTY']}</b></div>
                  </div>
                </div>
                <h4 style="border-bottom:1px solid #eee; padding-bottom:5px;">Size Breakdown</h4>`;
    
    html += rawSizes.map(s => {
      const parts = s.split(':');
      const name = parts[0].trim();
      if(!name) return '';
      const qty = parts.length > 1 ? parseInt(parts[1]) : 'N/A';
      
      let badge = '';
      if (qty === 'N/A') badge = `<span class="stock-badge" style="background:#eee; color:#666;">Unknown</span>`;
      else if (qty > 0) badge = `<span class="stock-badge in-stock">${qty} In Stock</span>`;
      else badge = `<span class="stock-badge out-stock">Out of Stock</span>`;

      return `<div class="view-row">
                <span style="font-weight:500;">Size ${name}</span>
                ${badge}
              </div>`;
    }).join('');

    $('#viewContent').html(html);
    $('#viewModal').show();
  }

  function invAddNew(type) {
    const val = prompt("Enter new " + type + ":");
    if (!val) return;
    $('#processingOverlay').css('display', 'flex'); 
    google.script.run
      .withFailureHandler(err => { $('#processingOverlay').hide(); alert("Error: " + err.message); })
      .withSuccessHandler(res => { 
        $('#processingOverlay').hide(); 
        if (res && res.success) { alert("Added!"); invLoad(); }
      })
      .itemAddNewDimension(type, val);
  }

  function invPreviewImage(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        $('#imgPreview').html(`<img src="${e.target.result}" style="width:100%; height:100%; object-fit:cover;">`);
        $('#processingOverlay').css('display', 'flex');
        google.script.run.withSuccessHandler(url => { $('#invImgUrl').val(url); $('#processingOverlay').hide(); }).itemUploadImage(e.target.result, input.files[0].name);
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function invAddVariant(data = null) {
    const id = 'var-' + Date.now();
    $('#variantContainer').append(`
      <div id="${id}" style="display:flex; gap:10px; margin-bottom:8px;">
        <input type="text" class="v-size" placeholder="Size" value="${data ? data.Size : ''}">
        <input type="number" class="v-stock" placeholder="Stock" value="${data ? data.Opening : 0}">
        <button class="btn btn-outline" onclick="this.parentElement.remove()">X</button>
      </div>`);
  }

  function invOpenModal() { $('#invModal').show(); $('#variantContainer').empty(); invAddVariant(); }
  function invCloseModal() { $('#invModal').hide(); }

  function invSave() {
    const data = {
      name: $('#invName').val(), brand: $('#invBrand').val(), category: $('#invCategory').val(),
      subcategory: $('#invSubcat').val(), reorderLevel: $('#invReorder').val(),
      imageUrl: $('#invImgUrl').val(), variants: []
    };
    $('#variantContainer > div').each(function() {
      data.variants.push({ size: $(this).find('.v-size').val(), openingStock: $(this).find('.v-stock').val(), id: "AUTO" });
    });
    $('#processingOverlay').css('display', 'flex');
    google.script.run.withSuccessHandler(() => location.reload()).itemSaveProductWithVariants(data);
  }

  function invDeleteItem(id) { if(confirm("Delete?")) google.script.run.withSuccessHandler(() => location.reload()).itemDeleteItem(id); }
</script>
</body>
</html>