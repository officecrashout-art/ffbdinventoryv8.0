<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  
  <style>
    :root { --primary: #1abc9c; --bg: #f4f7f6; --card: #fff; --border: #dee2e6; --danger: #e74c3c; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 20px; font-size: 14px; }
    
    .panel { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 2px 10px rgba(0,0,0,0.03); margin-bottom: 20px; }
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 20px; }
    
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
    label { font-weight: 500; color: #555; display: block; margin-bottom: 5px; }
    input, select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
    
    /* Table Styling */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #f8f9fa; text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: #666; }
    td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; }
    
    /* Buttons */
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: #555; }
    .btn-add { background: #3498db; color: white; padding: 6px 12px; font-size: 12px; }

    .grand-total { font-size: 1.4rem; font-weight: 700; color: var(--primary); text-align: right; margin-top: 20px; }
    
    /* Select2 Tweaks */
    .select2-container .select2-selection--single { height: 38px !important; border-color: var(--border) !important; display:flex; align-items:center; }
    
    #loader { display:none; position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:999; justify-content:center; align-items:center; }
  </style>
</head>
<body>

<div id="loader"><i class="fas fa-spinner fa-spin fa-3x" style="color:var(--primary)"></i></div>

<div class="panel">
  <div class="header-row">
    <h2 style="margin:0; color: var(--primary);"><i class="fas fa-shopping-cart"></i> New Sales Order</h2>
    <div style="text-align:right;">
      <label>Order ID</label>
      <input type="text" id="soID" readonly style="background:#f8f9fa; font-weight:bold; width:120px; text-align:center;">
    </div>
  </div>

  <div class="form-row" style="background:#fcfcfc; padding:15px; border-radius:8px; border:1px dashed #ccc;">
    <div style="grid-column: span 2;">
       <label>Customer <span style="font-size:11px; color:#999;">(Search or Select "New Customer")</span></label>
       <select id="soCustomer" onchange="soToggleCustomer()">
         <option value="">Select Customer...</option>
         <option value="NEW">+ Create New Customer</option>
       </select>
    </div>
    <div id="newCustFields" style="display:none; grid-column: span 3; display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
       <div><label>Name</label><input type="text" id="newCustName"></div>
       <div><label>Phone</label><input type="text" id="newCustPhone"></div>
       <div><label>City</label><input type="text" id="newCustCity"></div>
       <div style="grid-column: span 3;"><label>Full Address</label><input type="text" id="newCustAddr"></div>
    </div>
  </div>

  <div class="form-row">
    <div><label>Invoice Number (Manual)</label><input type="text" id="soInvoice"></div>
  </div>
</div>

<div class="panel">
  <table id="soTable">
    <thead>
      <tr>
        <th width="35%">Product</th>
        <th width="15%">Size (Stock)</th>
        <th width="10%">Qty</th>
        <th width="15%">Price</th>
        <th width="10%">Shipping</th>
        <th width="10%">Total</th>
        <th width="5%"></th>
      </tr>
    </thead>
    <tbody id="soItemsBody"></tbody>
  </table>
  <button class="btn btn-outline" onclick="soAddRow()" style="margin-top:15px;">+ Add Item</button>

  <div class="grand-total" id="grandTotal">Total: ৳0.00</div>
</div>

<div style="text-align:right; margin-bottom:50px;">
  <button class="btn btn-primary" onclick="soSave()" style="padding: 12px 30px; font-size:16px;">
    <i class="fas fa-save"></i> Complete Order
  </button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
  let db = { items: [], customers: [] };

  $(document).ready(function() {
    $('#loader').css('display','flex');
    google.script.run.withSuccessHandler(init).getSalesStartupData();
  });

  function init(data) {
    db = data;
    $('#soID').val('SO-' + Math.floor(100000 + Math.random() * 900000));
    
    // Populate Customers
    const custSel = $('#soCustomer');
    data.customers.forEach(c => {
      custSel.append(new Option(`${c['Customer Name']} (${c['Customer Contact']})`, c['Customer ID']));
    });
    
    custSel.select2({ placeholder: "Search Customer...", width: '100%' });
    
    soAddRow(); // Add first row
    $('#loader').hide();
  }

  function soToggleCustomer() {
    const val = $('#soCustomer').val();
    if (val === 'NEW') {
      $('#newCustFields').css('display', 'grid');
    } else {
      $('#newCustFields').hide();
    }
  }

  function soAddRow() {
    const rowId = Date.now();
    const tr = `
      <tr id="row-${rowId}">
        <td><select class="item-select" style="width:100%" onchange="soItemChanged(${rowId})"></select></td>
        <td><select class="size-select" id="size-${rowId}"><option value="">-</option></select></td>
        <td><input type="number" class="qty" value="1" min="1" onchange="soCalc(${rowId})"></td>
        <td><input type="number" class="price" value="0" onchange="soCalc(${rowId})"></td>
        <td><input type="number" class="ship" value="0" onchange="soCalc(${rowId})"></td>
        <td class="row-total" style="font-weight:bold;">0.00</td>
        <td><i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="$('#row-${rowId}').remove(); soCalcTotal();"></i></td>
      </tr>`;
    $('#soItemsBody').append(tr);

    // Populate Item Dropdown
    const itemSel = $(`#row-${rowId} .item-select`);
    itemSel.append('<option value="">Select Product...</option>');
    db.items.forEach(i => {
      itemSel.append(new Option(`${i['Item Name']} (${i['Item ID']})`, i['Item ID']));
    });
    itemSel.select2({ width:'100%' });
  }

  // UPDATED: Parses "Size" string and fills dropdown
  function soItemChanged(rowId) {
    const itemId = $(`#row-${rowId} .item-select`).val();
    const item = db.items.find(i => i['Item ID'] === itemId);
    const sizeSel = $(`#size-${rowId}`).empty();
    
    if (item) {
      // Parse "S:10, M:5"
      const rawSizes = (item['Size'] || "").split(',');
      rawSizes.forEach(s => {
        const parts = s.split(':');
        const sName = parts[0].trim();
        const sQty = parts.length > 1 ? parseInt(parts[1]) : 0;
        
        // Only show if stock > 0
        if (sName) {
            const label = sQty > 0 ? `${sName} (Avail: ${sQty})` : `${sName} (Out of Stock)`;
            const opt = new Option(label, sName);
            if(sQty <= 0) opt.disabled = true;
            sizeSel.append(opt);
        }
      });
      // Default price (optional logic if you had price in inventory)
      $(`#row-${rowId} .price`).val(0); 
    }
    soCalc(rowId);
  }

  function soCalc(rowId) {
    const row = $(`#row-${rowId}`);
    const qty = parseFloat(row.find('.qty').val()) || 0;
    const price = parseFloat(row.find('.price').val()) || 0;
    const ship = parseFloat(row.find('.ship').val()) || 0;
    const total = (qty * price) + ship;
    
    row.find('.row-total').text(total.toFixed(2));
    soCalcTotal();
  }

  function soCalcTotal() {
    let grand = 0;
    $('.row-total').each(function() { grand += parseFloat($(this).text()) || 0; });
    $('#grandTotal').text('Total: ৳' + grand.toLocaleString());
  }

  function soSave() {
    const custVal = $('#soCustomer').val();
    if (!custVal) return alert("Please select a customer.");

    // Validate Rows
    const items = [];
    let valid = true;
    
    $('#soItemsBody tr').each(function() {
        const id = $(this).find('.item-select').val();
        const size = $(this).find('.size-select').val();
        if(id && !size) { valid = false; alert("Please select a size for all items."); return false; }
        
        if (id) {
            items.push({
                id: id,
                name: $(this).find('.item-select option:selected').text(),
                size: size,
                qty: $(this).find('.qty').val(),
                price: $(this).find('.price').val(),
                ship: $(this).find('.ship').val(),
                total: parseFloat($(this).find('.row-total').text()),
                // Add category data lookup if needed for reports
                category: db.items.find(i => i['Item ID']===id)['Item Category'],
                subcategory: db.items.find(i => i['Item ID']===id)['Item Subcategory']
            });
        }
    });

    if(!valid || items.length === 0) return;

    // Build Customer Object
    const customer = {
      isNew: custVal === 'NEW',
      id: custVal === 'NEW' ? null : custVal,
      name: custVal === 'NEW' ? $('#newCustName').val() : $('#soCustomer option:selected').text().split(' (')[0],
      contact: $('#newCustPhone').val(),
      city: $('#newCustCity').val(),
      address: $('#newCustAddr').val()
    };

    const soData = {
      id: $('#soID').val(),
      invoice: $('#soInvoice').val(),
      totalAmount: parseFloat($('#grandTotal').text().replace(/[^0-9.]/g, ''))
    };

    $('#loader').css('display','flex');
    google.script.run
      .withSuccessHandler(res => {
         $('#loader').hide();
         if(res.success) { alert(res.message); google.script.host.close(); }
      })
      .soSaveOrder(soData, items, customer);
  }
</script>
</body>
</html>