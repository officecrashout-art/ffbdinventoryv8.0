<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
  
  <style>
    :root { --primary: #3498db; --bg: #f4f7f6; --card: #fff; }
    body { font-family: 'Poppins', sans-serif; background: var(--bg); padding: 20px; }
    .card { background: var(--card); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  </style>
</head>
<body>

<div class="card" style="max-width: 500px; margin: 0 auto;">
  <h2 style="color:var(--primary); text-align:center;">Record Payment</h2>
  
  <div class="form-group">
    <label>Supplier</label>
    <select id="ptSup"></select>
  </div>
  
  <div class="form-group">
    <label>Pending PO</label>
    <select id="ptPO" disabled><option>Select Supplier first...</option></select>
  </div>
  
  <div class="form-group">
    <label>Amount (à§³)</label>
    <input type="number" id="ptAmt">
  </div>
  
  <div class="form-group">
    <label>Payment Mode</label>
    <select id="ptMode"><option>Cash</option><option>Bank</option><option>Mobile Money</option></select>
  </div>
  
  <button onclick="pay()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:6px; font-size:16px;">Save Payment</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
  let db = {};
  $(document).ready(() => {
    google.script.run.withSuccessHandler(d => {
      db = d;
      $('#ptSup').append('<option></option>');
      d.suppliers.forEach(s => $('#ptSup').append(new Option(s['Supplier Name'], s['Supplier ID'])));
      $('#ptSup').select2({ placeholder: 'Select Supplier' });
      $('#ptPO').select2();
    }).getPaymentStartupData();
  });

  $('#ptSup').on('change', function() {
    const sid = $(this).val();
    const poSel = $('#ptPO').empty().prop('disabled', false).append('<option></option>');
    
    const pending = db.pos.filter(p => p['Supplier ID'] === sid && p['PMT Status'] !== 'Paid');
    pending.forEach(p => poSel.append(new Option(`PO: ${p['PO ID']} (Due: ${p['PO Balance']})`, p['PO ID'])));
    
    if(!pending.length) poSel.append('<option disabled>No pending bills</option>');
  });

  $('#ptPO').on('change', function() {
    const pid = $(this).val();
    const po = db.pos.find(p => p['PO ID'] === pid);
    if(po) $('#ptAmt').val(po['PO Balance']);
  });

  function pay() {
    const data = {
      date: new Date(),
      id: 'PAY-' + Date.now(),
      supId: $('#ptSup').val(),
      supName: $('#ptSup option:selected').text(),
      poId: $('#ptPO').val(),
      bill: 'N/A',
      mode: $('#ptMode').val(),
      amount: $('#ptAmt').val()
    };
    
    if(!data.poId || !data.amount) return alert("Missing info");
    
    google.script.run.withSuccessHandler(() => {
      alert("Paid!");
      location.reload();
    }).ptSaveNewPayment(data);
  }
</script>
</body>
</html>